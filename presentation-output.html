<!--
Google IO 2012 HTML5 Slide Template

Authors: Eric Bidelman <ebidel@gmail.com>
         Luke Mahe <lukem@google.com>

URL: https://code.google.com/p/io-2012-slides
-->
<!DOCTYPE html>
<html>
<head>
  <title>eZ Summercamp 2013</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">-->
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
  <!--This one seems to work all the time, but really small on ipad-->
  <!--<meta name="viewport" content="initial-scale=0.4">-->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" media="all" href="theme/css/default.css">
  <!--link rel="stylesheet" media="all" href="theme/css/app.css"-->
  <link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="theme/css/phone.css">
  <base target="_blank"> <!-- This amazingness opens all links in a new tab. -->
  <script data-main="js/slides" src="js/require-1.0.8.min.js"></script>
</head>
<body style="opacity: 0">

<slides class="layout-widescreen">

<slide class="logoslide nobackground">
  <article class="flexbox vcenter">
    <span><img src="images/cjwlogo.png"></span>
  </article>
</slide>

<slide class="title-slide segue nobackground">
  <aside class="gdbar"><img src="images/cjwlogo_128.png"></aside>
  <!-- The content of this hgroup is replaced programmatically through the slide_config.json. -->
  <hgroup class="auto-fadein">
    <h1 data-config-title><!-- populated from slide_config.json --></h1>
    <h2 data-config-subtitle><!-- populated from slide_config.json --></h2>
    <p data-config-presenter><!-- populated from slide_config.json --></p>
  </hgroup>
</slide>


<slide class="big" >
  
    <hgroup>
      <h2>Presenters</h2>
      <h3></h3>
    </hgroup>
    <article ><!---

  eZ Summercamp 2014 Talk

  Learnings from Real eZ Publish 5 Projects

  (c) 2014 Ekkehard DÃ¶rre, Donat Fritschy

-->

<ul class="build">
<li><strong>Donat</strong> is owner of Webmanufaktur, a full service web agency in Switzerland. He works as projects manager, software architect and developer and likes thinking outside of the box. In the last year he has been involved in major eZ 5 projects.</li>
<li><strong>Ekke</strong> is a consultant with deep knowledge in eZ Publish 4 and 5, eZ Find / Apache Solr and with a faible for coming cutting edge web technologies. He is one of the organizers of the PHP Unconference since eight years.</li>
<li>Members of CJW Network</li>
</ul></article>
 
</slide>

<slide class="big" >
  
    <hgroup>
      <h2>Learnings from Real eZ Publish 5 Projects</h2>
      <h3></h3>
    </hgroup>
    <article ><ul class="build">
<li>Last year we have presented our Cookbok...</li>
<li>
<p>... today you get a Ratatouille ;-)</p>
</li>
<li>
<p>Let's share the experiences you and we made in the last year!</p>
</li>
</ul></article>
 
</slide>

<slide class="big" >
  
    <hgroup>
      <h2>Agenda</h2>
      <h3></h3>
    </hgroup>
    <article ><p>Things we would like to discuss:</p>
<ul class="build">
<li>Good Practice</li>
<li>ez View Cache vs. HTTP Cache</li>
<li>Debugging</li>
<li>Pitfalls</li>
<li>MultiSite Setup</li>
</ul></article>
 
</slide>

<slide class="segue dark nobackground" >
  
    <aside class="gdbar"><img src="images/cjwlogo_128.png"></aside>
    <hgroup class="auto-fadein">
      <h2>Good Practice</h2>
      <h3></h3>
    </hgroup>
  
</slide>

<slide  >
  
    <hgroup>
      <h2>Team up with a Symfony Crack</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>To be honest: as eZ 4 developers, we are complete novices in eZ 5</li>
<li>It's easier for a Smyfony Crack to learn eZ than other way round</li>
<li>Symfony community is hungry for a CMS, so watch out for new competition</li>
<li>But @Symfony cracks: It's not easy: an eZ Publish and CMS expert will reduce your risk</li>
<li>and will make your content architecture better and more maintainable</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Think in MVC</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>A radical different thinking</li>
<li>eZ 4 mangled all together in the TPL -&gt; the view implemented the logic (fetch)</li>
<li>Symfony enforces a clean separation, from routing to the controller to the rendering of the view</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Think in Bundles</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>Split your application in different bundles (site specific, functional, ...)</li>
<li>Reuse your code: create and maintain a Base Bundle with general functions</li>
</ul>
<p>Creating bundles is easy, don't work in the DemoBundle ;-)</p>
<pre class="prettyprint" data-lang="bash">
$ php ezpublish/console generate:bundle
</pre></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Organize your config files</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>The standard eZ installation is a mess...</li>
<li>... and the DemoBundle only slowly becoming a source of good practice</li>
</ul>
<p>Our approach</p>
<ul>
<li>keep config in <code>ezpublish/config</code> as general as possible</li>
<li>it should merely describe your environment, not the application</li>
<li>move all site/function specific settings to the bundle</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Keep ezpublish.yml small</h2>
      <h3></h3>
    </hgroup>
    <article ><p><code>ezpublish/config/ezpublish.yml</code></p>
<pre class="prettyprint" data-lang="yml">
imports:
    - {resource: "@CjwExampleBundle/Resources/config/ezpublish.yml"}
</pre>

<p>Keep these sections:</p>
<ul>
<li>doctrine (Database)</li>
<li>ezpublish (Siteaccess Matching, Siteaccesses, Languages, Caching)</li>
<li>stash</li>
</ul>
<p>Can even be shorter - get inspiration from <a href="https://github.com/lolautruche/metalfrance">https://github.com/lolautruche/metalfrance</a></p>
<p><em>Note: prepending configuration does not work well with parameters</em></p></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Config Files in Bundle</h2>
      <h3></h3>
    </hgroup>
    <article ><p>We keep them in a separate directory and name them as in good old eZ...</p>
<pre>
ExampleBundle
&#8990; Resources
  &#8990; config
    &#8990; ezpublish
        image.yml
        override.yml
      ezpublish.yml
      parameters.yml
      routing.yml
      services.yml
</pre></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Controllers</h2>
      <h3></h3>
    </hgroup>
    <article ><p>After several tries, we ended up with...</p>
<ul>
<li>Basically one controller per full view</li>
<li>Separate controllers for navigation etc.</li>
<li>Retrieve all needed data (location, children, ...)</li>
<li>Prepare the data for easy processing in the templates</li>
<li>Consider caching (TTL, X-Location Header)</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Ways to Fetch Content</h2>
      <h3></h3>
    </hgroup>
    <article ><ul class="build">
<li>LocationService::loadLocation()</li>
<li>
<p>ContentService::loadContent()</p>
</li>
<li>
<p>SearchService::findContent()</p>
</li>
<li>
<p>SearchService::findLocations()</p>
</li>
<li>
<p>LocationService::loadLocationChildren()</p>
</li>
<li>
<p>Legacy fetch functions</p>
</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>SearchService::findContent()</h2>
      <h3></h3>
    </hgroup>
    <article ><p>The only <code>SearchService</code> function you will find in <code>DemoBundle</code> ...</p>
<ul class="build">
<li>returns full <code>content</code> objects with ALL attributes in ALL languages</li>
<li>does not work <s>well</s> with multiple locations</li>
<li>scales very badly</li>
<li>
<p>no <code>asObjects</code> flag as in eZ 4</p>
</li>
<li>
<p>fetching a content tree with 116 locations took 30 seconds</p>
</li>
<li>most of the time is spent in manipulating the SQL result in PHP</li>
<li>Another test: 24 hits, PHP array 44'880 rows with 39 elements each, highly redundant</li>
</ul>
<p><a href="http://share.ez.no/blogs/donat-fritschy/searchservice-performance">http://share.ez.no/blogs/donat-fritschy/searchservice-performance</a></p></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>SearchService::findLocations()</h2>
      <h3></h3>
    </hgroup>
    <article ><p><strong>Available from 2014.05 / 5.3 only</strong></p>
<p>Roughly equivalent to good old <code>fetch( 'content', 'list' )</code></p>
<ul class="build">
<li>returns <code>location</code> objects with <code>contentInfo</code> only</li>
<li>fetching a content tree with 116 locations took &lt; 1 second</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>LocationService::loadLocationChildren()</h2>
      <h3></h3>
    </hgroup>
    <article ><p>&laquo;Think of <code>LocationService::loadLocationChildren()</code> as primarily intended for administration interface.&raquo;</p>
<p>&laquo;If what it offers suits you for the frontend as well, great, but otherwise you will have to use SearchService. In other words, this method will not get filtering capabilities.&raquo;</p>
<p><em>(From a discussion with Petar)</em></p>
<p><a href="http://www.netgenlabs.com/Blog/Fetching-content-in-eZ-Publish-5-using-Search-service">http://www.netgenlabs.com/Blog/Fetching-content-in-eZ-Publish-5-using-Search-service</a></p></article>
 
</slide>

<slide class="smaller" >
  
    <hgroup>
      <h2>Legacy Fetch Functions</h2>
      <h3></h3>
    </hgroup>
    <article ><pre class="prettyprint" data-lang="php">
use eZFunctionHandler;
...
$mySearchResults = $this->getLegacyKernel()->runCallback(
    function () use ( $searchPhrase, $sort, $contentTypeIdenfiers )
    {
        // eZFunctionHandler::execute is the equivalent for a legacy template fetch function
        // The following is the same than fetch( 'ezfind', 'search', hash(...) )
        return eZFunctionHandler::execute(
            'ezfind',
            'search',
            array(
                'query'     => $searchPhrase,
                'sort_by'   => $sort,
                'class_id'  => $contentTypeIdenfiers
            )
        );
    }
);
</pre></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>TWIG Templates</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>A generalized full and line view template for the easy stuff</li>
<li>And again, basically one template per full view</li>
</ul>
<p>How to handle children (sub items)?</p>
<ul>
<li>render directly in the template - the data is usually already there</li>
<li>use <code>{{ render( controller( 'ez_content:viewLocation', {'locationId': child.id, 'viewType': 'line'} )) }}</code></li>
</ul>
<p>When to use ESI?</p>
<ul>
<li>nice concept, but quite a big overhead</li>
<li>better suited for larger chunks</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>How to organize Templates?</h2>
      <h3></h3>
    </hgroup>
    <article ><p>The Symfony way...</p>
<pre>
views
&#8990; Customer
    CustomerDetail.html.twig
&#8990; Product
</pre>

<p>The classic eZ way...</p>
<pre>
views
&#8990; full
    customer.html.twig
&#8990; line
</pre>

<p>Two approaches, both valid. Follow your taste.</p></article>
 
</slide>

<slide class="segue dark nobackground" >
  
    <aside class="gdbar"><img src="images/cjwlogo_128.png"></aside>
    <hgroup class="auto-fadein">
      <h2>eZ View Cache vs. HTTP Caching</h2>
      <h3></h3>
    </hgroup>
  
</slide>

<slide  >
  
    <hgroup>
      <h2>eZ View Caching (Legacy)</h2>
      <h3></h3>
    </hgroup>
    <article ><p>When the pagelayout is rendered, the <code>{$module_result.content}</code> part will be replaced with the actual output. If view caching is enabled, the entire result of the module will be cached. This means that the contents of the "module_result" variable will be put into a cache file (...)</p>
<p>When a new version (...) of an object is published, the system will automatically clear the view cache for the following items:</p>
<ul>
<li>All published nodes of the object</li>
<li>The parent nodes</li>
<li>Related nodes (keywords, object relations)</li>
</ul>
<p><a href="https://doc.ez.no/eZ-Publish/Technical-manual/4.x/Features/View-caching">https://doc.ez.no/eZ-Publish/Technical-manual/4.x/Features/View-caching</a></p></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>HTTP Expiration and Validation (Symfony)</h2>
      <h3></h3>
    </hgroup>
    <article ><p>The HTTP specification defines two caching models:</p>
<ul class="build">
<li>With the <strong>expiration model</strong>, you simply specify how long a response should be considered "fresh" by including a Cache-Control and/or an Expires header. Caches that understand expiration will not make the same request until the cached version reaches its expiration time and becomes "stale";</li>
<li>When pages are really dynamic (i.e. their representation changes often), the <strong>validation model</strong> is often necessary. With this model, the cache stores the response, but asks the server on each request whether or not the cached response is still valid. The application uses a unique response identifier (the Etag header) and/or a timestamp (the Last-Modified header) to check if the page has changed since being cached.</li>
</ul>
<p><a href="http://symfony.com/doc/current/book/http_cache.html">http://symfony.com/doc/current/book/http_cache.html</a></p></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>In Short (and much simplified...)</h2>
      <h3></h3>
    </hgroup>
    <article ><p>eZ View Cache caches <strong>content</strong> and <strong>content fragments</strong></p>
<ul>
<li>Standard TTL is 2 hours</li>
<li>Is purged on content modifications (with smart cache clearing rules)</li>
</ul>
<p>Symfony's HTTP Cache caches <strong>requests</strong></p>
<ul>
<li>eZ uses Expiration model by default</li>
<li>Standard TTL is 60 seconds (86400 for tree menu!)</li>
<li>Symfony Cache is purged from backend, <strong>but only for ONE location</strong></li>
</ul>
<p>Let's dive in a bit deeper...</p></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>ez 4 Cache Directives</h2>
      <h3></h3>
    </hgroup>
    <article ><p>Code from <code>ezpublish_legacy/kernel/private/classes/ezpkernelweb.php</code></p>
<pre class="prettyprint" data-lang="php">
// send header information
foreach (
    eZHTTPHeader::headerOverrideArray( $this->uri ) +
    array(
        <b>'Expires' => 'Mon, 26 Jul 1997 05:00:00 GMT',
        'Last-Modified' => gmdate( 'D, d M Y H:i:s' ) . ' GMT',
        'Cache-Control' => 'no-cache, must-revalidate',
        'Pragma' => 'no-cache',</b>
        ...
      ) as $key => $value
)
{
    header( $key . ': ' . $value );
}
</pre>

<p><strong>This guarantees that every request is handled by eZ</strong></p></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>eZ 5 Cache Directives</h2>
      <h3></h3>
    </hgroup>
    <article ><p>Code from <code>vendor/ezsystems/demobundle/EzSystems/DemoBundle/Controller/DemoController.php</code></p>
<pre class="prettyprint" data-lang="php">
// Setting HTTP cache for the response to be public and with a TTL of 1 day.
$response = new Response;
$response->setPublic();
$response->setSharedMaxAge( 86400 );
// Menu will expire when top location cache expires.
$response->headers->set( 'X-Location-Id', $rootLocationId );
// Menu might vary depending on user permissions, so make the cache vary on the user hash.
$response->setVary( 'X-User-Hash' );
</pre>

<p><strong>This effectively sets the Response free, out of the reach of eZ</strong></p></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Emulating eZ 4 Cache behaviour in eZ 5</h2>
      <h3></h3>
    </hgroup>
    <article ><p>This patch to <code>index.php</code> disables client and proxy caching without sacrificing the benefits of the Symfony HTTP cache. Use at own risk!</p>
<pre class="prettyprint" data-lang="php">
$response = $kernel->handle( $request );
<b>
// Emulate eZ 4 cache control
$response->headers->set( 'Cache-Control', 'no-cache, must-revalidate' );
</b>
$response->send();
$kernel->terminate( $request, $response );
</pre></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Cache Recommendations</h2>
      <h3></h3>
    </hgroup>
    <article ><ul class="build">
<li>Read the specifications</li>
<li>Use Shared Caches with caution</li>
<li>Cave: <code>setTtl()</code> vs. <code>setClientTtl</code></li>
<li>Set TTL as high as possible</li>
<li>
<p>Use Varnish</p>
</li>
<li>
<p><a href="http://tools.ietf.org/html/rfc2616#page-74">http://tools.ietf.org/html/rfc2616#page-74</a></p>
</li>
<li><a href="https://www.mnot.net/cache_docs/">https://www.mnot.net/cache_docs/</a></li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Cache per User - yml config</h2>
      <h3></h3>
    </hgroup>
    <article ><p><code>src/Cjw/SiteCustomerBundle/Ressources/config/services.yml</code></p>
<pre class="prettyprint" data-lang="yml">

parameters:
    cjw_site_customer.user_hash_definer.class: Cjw\SiteCustomerBundle\Identity\UserHashDefiner

services:
    cjw_site_customer.user_hash_definer:
        class: %cjw_site_customer.user_hash_definer.class%
        tags:
          - { name: ezpublish.identity_definer }
        arguments: [@ezpublish.api.repository]

</pre></article>
 
</slide>

<slide class="smaller" >
  
    <hgroup>
      <h2>Cache per User - User Hash Definer</h2>
      <h3></h3>
    </hgroup>
    <article ><p><code>src/Cjw/SiteCustomerBundle/Identity/UserHashDefiner.php</code>
<pre class="prettyprint" data-lang="php">
namespace Cjw\SiteCustomerBundle\Identity;
use eZ\Publish\SPI\User\IdentityAware;
use eZ\Publish\SPI\User\Identity;
use eZ\Publish\API\Repository\Repository;
class UserHashDefiner implements IdentityAware
{
    private $repository;
    public function __construct(Repository $repository)
    {
        $this-&gt;repository = $repository;
    }
    public function setIdentity(Identity $identity)
    {
        $current_user = $this-&gt;repository-&gt;getCurrentUser();
        $identity-&gt;setInformation('UserID', $current_user-&gt;contentInfo-&gt;id);
    }
}
</pre></p></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Cache per User - yml config</h2>
      <h3></h3>
    </hgroup>
    <article ><p><code>src/Cjw/SiteCustomerBundle/Ressources/config/services.yml</code></p>
<pre class="prettyprint" data-lang="yml">

parameters:
    cjw_site_customer.user_hash_definer.class: Cjw\SiteCustomerBundle\Identity\UserHashDefiner

services:
    cjw_site_customer.user_hash_definer:
        class: %cjw_site_customer.user_hash_definer.class%
        tags:
          - { name: ezpublish.identity_definer }
        arguments: [@ezpublish.api.repository]

</pre></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Cache per User - Controller</h2>
      <h3></h3>
    </hgroup>
    <article ><p><code>src/Cjw/SiteCustomerBundle/Controller/CjwController.php</code></p>
<pre class="prettyprint" data-lang="php">

    public function sectionInternalAction($locationId, $viewType, $layout = false, array $params = array())
    {
        $response = new Response();
        $response->setPrivate();
        $response->headers->set('X-Location-Id', $locationId);
        $response->setVary('X-User-Hash');
        return $response;
    }
</pre></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Cache per User - Location View Config</h2>
      <h3></h3>
    </hgroup>
    <article ><p><code>src/Cjw/SiteCustomerBundle/Ressources/config/ezpublish/override.yml</code></p>
<pre class="prettyprint" data-lang="yml">

system:
    customer_user_de:
        location_view:
            full:
                section_internal:
                    controller:  "CjwSiteCustomerBundle:Cjw:sectionInternal"
                    match:
                        Identifier\Section: internal

</pre></article>
 
</slide>

<slide class="segue dark nobackground" >
  
    <aside class="gdbar"><img src="images/cjwlogo_128.png"></aside>
    <hgroup class="auto-fadein">
      <h2>Debugging</h2>
      <h3>Coping with blank screens</h3>
    </hgroup>
  
</slide>

<slide  >
  
    <hgroup>
      <h2>Blank screen, "503 Service not available"</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>PHP errors (Syntax error, Memory, Outdated Autoloads, ...)</li>
<li>
<p>Configuration errors (DB connection, ...)</p>
</li>
<li>
<p>Switch to DEV mode for better debugging</p>
</li>
<li>Check the log files
<pre>
    Apache/PHP Log
    ezpublish/logs/&lt;env&gt;.log
    ezpublish_legacy/var/log/*
    ezpublish_legacy/var/&lt;siteaccess&gt;/log/*
</pre></li>
<li>Check write permissions on log files!</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>TwigBundle:Exception:error500.html.twig</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>NEVER a Twig error!</li>
<li>
<p>Caused by response 500 "Internal Server Error" and missing error template</p>
</li>
<li>
<p>Checks as before</p>
</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Twig Exception: Invalid variation "&lt;variation&gt;"</h2>
      <h3></h3>
    </hgroup>
    <article ><p>Caused by problems when accessing images</p>
<ul>
<li>Check if the file exists</li>
<li>Check permissions on <code>ezpublish_legacy/var/&lt;siteaccess&gt;/storage</code></li>
<li>Check log files</li>
<li>Clear cache</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Class 'ezxFormToken' not found</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>Usually found with fresh installations involving legacy extensions</li>
<li>Regenerate Autoloads</li>
</ul>
<pre class="prettyprint" data-lang="bash">
$ cd ezpublish_legacy
$ php bin/php/ezpgenerateautoloads.php -e -p
</pre></article>
 
</slide>

<slide class="segue dark nobackground" >
  
    <aside class="gdbar"><img src="images/cjwlogo_128.png"></aside>
    <hgroup class="auto-fadein">
      <h2>Pitfalls</h2>
      <h3>Avoid the traps...</h3>
    </hgroup>
  
</slide>

<slide  >
  
    <hgroup>
      <h2>Memory limit exceeded in DEV mode</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>DEV mode takes a lot of memory</li>
<li>Stash Logging is the worst</li>
<li>Disable Stash Logging in ezpublish.yml</li>
</ul>
<pre class="prettyprint" data-lang="yml">
stash:
    <b>logging: false</b>
    caches:
        default:
            handlers:
                - FileSystem
            inMemory: true
            registerDoctrineAdapter: false
</pre></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>414 Request-URI Too Long</h2>
      <h3></h3>
    </hgroup>
    <article ><p>When doing subrequests, particularly ESI or Hinclude ones, current SiteAccess is transmitted in a serialized form, with its matcher. With a large number of configured SiteAccesses using Map\Host or Map\URI matcher (around 40, which is not uncommon for a multi-national, multi-lingual site) the URL can exceed the size of 8192 Bytes which most servers accept. As a result, the ESI/Hinclude call fails.</p>
<ul>
<li>Fixed in Version 5.3.3 (2014.07)</li>
<li><a href="https://jira.ez.no/browse/EZP-23168">https://jira.ez.no/browse/EZP-23168</a></li>
<li><a href="https://github.com/ezsystems/ezpublish-kernel/pull/949">https://github.com/ezsystems/ezpublish-kernel/pull/949</a></li>
</ul></article>
 
</slide>

<slide class="segue dark nobackground" >
  
    <aside class="gdbar"><img src="images/cjwlogo_128.png"></aside>
    <hgroup class="auto-fadein">
      <h2>Multi-Site/Multi-Repository Setup</h2>
      <h3></h3>
    </hgroup>
  
</slide>

<slide  >
  
    <hgroup>
      <h2>Why a Multi-Site/Multi-Repository Setup?</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>At CJW Network we have developed a multi-site/multi-repository setup for eZ Publish 4 several years ago</li>
<li>This allows us to host many individual sites on a single eZ Publish installation</li>
</ul>
<p>Advantages:</p>
<ul>
<li>Central site administration (site activation, cronjobs, ...)</li>
<li>Easy deployment (update site extension with Subversion)</li>
<li>Highly reduced maintenance costs (security patches, upgrades)</li>
<li>Highly efficient use of hardware resources</li>
</ul>
<p>Disadvantages:</p>
<ul>
<li>Some Kernel patches needed</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Multi-Site/Multi-Repository Setup in eZ 5</h2>
      <h3></h3>
    </hgroup>
    <article ><p>First Approach (proven in production)</p>
<ul>
<li>Use different <code>ezpublish</code> app directories to host the different sites</li>
</ul>
<p>Second approach (under development)</p>
<ul>
<li>Use <code>CJW MultiSiteBundle</code></li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Directory structure - Multi-Site-Setup (old)</h2>
      <h3></h3>
    </hgroup>
    <article ><pre class="">
ezpublish                &lt;-- not used
ezpublish_legacy
&#8990;extension
 &#8990;site_customer          &lt;-- each customer has its own extension and database
 &#8990;site_customertwo
&#8990;var
 &#8990;site_customer          &lt;-- each customer has its own var directory
 &#8990;site_customertwo
site_customer            &lt;-- each customer has its own Symfony app
site_customertwo
src
&#8990;CjwNetwork
 &#8990;SiteCustomerBundle     &lt;-- each customer has its own bundle
 &#8990;SiteCustomertwoBundle
</pre></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Multi-Site-Setup (old) Detail ezpublish_legacy</h2>
      <h3></h3>
    </hgroup>
    <article ><pre class="">
ezpublish_legacy
&#8990;extension
 &#8990;site_customer          &lt;-- each customer has its own extension
  &#8990;classes
  &#8990;design
  &#8990;modules
  &#8990;settings
   &#8990;site.ini
    &#8990;[DatabaseSettings]  &lt;-- each customer has its own database
     &#8990;Database=database_site_customer
 &#8990;site_customertwo
  &#8990;[...]
  &#8990;settings
   &#8990;site.ini
    &#8990;[DatabaseSettings]
     &#8990;Database=database_site_customertwo
&#8990;var
 &#8990;site_customer          &lt;-- each customer has its own var directory
 &#8990;site_customertwo
</pre></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Detail site_customer App - Multi-Site-Setup (old)</h2>
      <h3></h3>
    </hgroup>
    <article ><pre class="">
site_customer
&#8990;autoload.php
&#8990;bootstrap.php.cache
&#8990;cache
&#8990;check.php
&#8990;config    &lt;-- all yml files like ezpublish folder, (to improve)
 &#8990;config.yml
 &#8990;ezpublish.yml
&#8990; parameters.yml
&#8990;console
&#8990;logs
&#8990;phpunit.xml.dist
&#8990;Resources
&#8990;sessions
&#8990;SiteCjwbaseCache.php
&#8990;SiteCjwbaseKernel.php
&#8990;SymfonyRequirements.php
</pre></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Scripts on Shell - Multi-Site-Setup (old)</h2>
      <h3></h3>
    </hgroup>
    <article ><pre class="prettyprint" data-lang="bash">
# Generate symlinks
php site_customer/console assets:install --symlink web
php site_customer/console ezpublish:legacy:assets_install --symlink web

# Clear Cache
php site_customer/console --env=prod cache:clear

# Dump assets
php site_customer/console assetic:dump --env=prod web

# Run cronjobs
php site_customer/console ezpublish:legacy:script runcronjobs.php --siteaccess customer_user_de cjw_newsletter
</pre></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Multiple Apps: Multi-Site-Setup (old)</h2>
      <h3></h3>
    </hgroup>
    <article ><ul class="build">
<li>You can use one development environment with many projects</li>
<li>You can use one or more production servers  or</li>
<li>easily check out customer to different servers</li>
<li>all customer are encapsulated apps</li>
<li>solid and proven for more than 1,5 years</li>
<li>Examples ...</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Introducing CJW MultiSiteBundle</h2>
      <h3></h3>
    </hgroup>
    <article ><p>Although the first approach works fine, it has several drawbacks:</p>
<ul class="build">
<li>Application code scattered at different places (site directory, bundle, legacy extension), hard to maintain in VCS, hard to deploy</li>
<li>Redundancy in config files</li>
<li>No global settings</li>
<li>
<p>No central site activation/administration</p>
</li>
<li>
<p>Goal: keep everything in one place!</p>
</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>CJW MultiSiteBundle Features</h2>
      <h3></h3>
    </hgroup>
    <article ><ul class="build">
<li>Boots kernel and environment based on domain name mappings</li>
<li>Handles local, staging and live domain names</li>
<li>Allows for global activation of bundles</li>
<li>Allows for global settings</li>
<li>Provides a common console for all sites</li>
<li>Caches domain name mappings</li>
<li>Moves cache and log files away from the ezpublish folder</li>
<li>more to come ...</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>cjwpublish Directory</h2>
      <h3></h3>
    </hgroup>
    <article ><p>The <code>cjwpublish</code> application directory sits next to the <code>ezpublish</code> directory.</p>
<pre class="">
cjwpublish
&#8990; config
    cjwpublish.yml                  &lt;-- defines active bundles
    config.yml                      &lt;-- allows for global settings
  CjwPublishKernel.php              &lt;-- inherits from CjwMultiSiteKernel.php
  CjwPublishCache.php               &lt;-- inherits from CjwMultiSiteCache.php
  console
</pre></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Symfony's app directory is back</h2>
      <h3></h3>
    </hgroup>
    <article ><p>Site Bundle Directory Layout</p>
<pre class="">
src
&#8990; Cjw
  &#8990; SiteExampleBundle
    &#8990; app
      &#8990; config
          cjwpublish.yml            &lt;-- contains domain mappings
          config.yml
          ezpublish.yml
          ...
        CjwSiteExampleKernel.php    &lt;-- inherits from CjwPublishKernel.php
        CjwSiteExampleCache.php     &lt;-- inherits from CjwPublishCache.php
    &#8990; Controller
      ...
</pre></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Caveats</h2>
      <h3></h3>
    </hgroup>
    <article ><p>Adjustments needed in <code>config.yml</code> to reflect different relative location of kernel</p>
<pre class="prettyprint" data-lang="yml">
assetic:
    ...
    read_from:      %kernel.root_dir%/../../../../web
    write_to:       %kernel.root_dir%/../../../../web
    ...
ez_publish_legacy:
    ...
    root_dir: %kernel.root_dir%/../../../../ezpublish_legacy

parameters:
    ezpublish.kernel.root_dir: %kernel.root_dir%/../../../../vendor/ezsystems/ezpublish-kernel
</pre>

<p><strong>More problems of this kind expected!</strong></p></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Project Status</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>Currently in private Beta, not yet released</li>
<li>Ideas and Feedback welcome</li>
<li>
<p>Public Beta in October</p>
</li>
<li>
<p><a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#105;&#110;&#102;&#111;&#64;&#99;&#106;&#119;&#45;&#110;&#101;&#116;&#119;&#111;&#114;&#107;&#46;&#99;&#111;&#109;">&#105;&#110;&#102;&#111;&#64;&#99;&#106;&#119;&#45;&#110;&#101;&#116;&#119;&#111;&#114;&#107;&#46;&#99;&#111;&#109;</a></p>
</li>
<li><a href="https://github.com/cjw-network/MultiSiteBundle">https://github.com/cjw-network/MultiSiteBundle</a></li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Ressources</h2>
      <h3></h3>
    </hgroup>
    <article ><p>Slides as PDF</p>
<ul>
<li>see <code>src/Cjw/SummerCampBundle/Resources/doc/learnings.pdf</code></li>
<li><a href="https://github.com/cjw-network/SummerCampBundle/Resources/doc/learnings.pdf">https://github.com/cjw-network/SummerCampBundle/Resources/doc/learnings.pdf</a></li>
</ul>
<p>Slides (Source)</p>
<ul>
<li><a href="https://github.com/dfritschy/cjw-summercamp-slides">https://github.com/dfritschy/cjw-summercamp-slides</a></li>
</ul>
<p>CJW MultiSiteBundle</p>
<ul>
<li><a href="https://github.com/cjw-network/MultiSiteBundle">https://github.com/cjw-network/MultiSiteBundle</a></li>
<li><a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#105;&#110;&#102;&#111;&#64;&#99;&#106;&#119;&#45;&#110;&#101;&#116;&#119;&#111;&#114;&#107;&#46;&#99;&#111;&#109;">&#105;&#110;&#102;&#111;&#64;&#99;&#106;&#119;&#45;&#110;&#101;&#116;&#119;&#111;&#114;&#107;&#46;&#99;&#111;&#109;</a></li>
</ul></article>
 
</slide>

<slide class="segue dark nobackground" >
  
    <aside class="gdbar"><img src="images/cjwlogo_128.png"></aside>
    <hgroup class="auto-fadein">
      <h2><a href="http://vote.netgenlabs.com/" style="color:#fff;">http://vote.netgenlabs.com/</a></h2>
      <h3>Please Vote!</h3>
    </hgroup>
  
</slide>


<slide class="thank-you-slide segue nobackground">
  <aside class="gdbar right"><img src="images/cjwlogo_128.png"></aside>
  <article class="flexbox vleft auto-fadein">
    <h2>&lt;Thank You!&gt;</h2>
    <p>Ekkehard D&ouml;rre<br>
    <a href="http://share.ez.no/community/profile/7431">http://share.ez.no/community/profile/7431</a><br>
    <a href="https://twitter.com/ekkeD">@ekkeD</a><br>
    <a href="http://www.coolscreen.de">http://www.coolscreen.de</a></p>
    <p>Donat Fritschy<br>
    <a href="https://github.com/dfritschy">https://github.com/dfritschy</a><br>
    <a href="http://share.ez.no/community/profile/10451">http://share.ez.no/community/profile/10451</a><br>
    <a href="https://twitter.com/webmanufaktur">@webmanufaktur</a><br>
    <a href="http://www.webmanufaktur.ch">http://www.webmanufaktur.ch</a></p>
  </article>
  <!--
  <p class="auto-fadein" data-config-contact>
    <!-- populated from slide_config.json - ->
  </p>
  -->
</slide>

<slide class="backdrop"></slide>

</slides>

<!--
<script>
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-XXXXXXXX-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>
-->

<!--[if IE]>
  <script src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js"></script>
  <script>CFInstall.check({mode: 'overlay'});</script>
<![endif]-->
</body>
</html>