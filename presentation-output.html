<!--
Google IO 2012 HTML5 Slide Template

Authors: Eric Bidelman <ebidel@gmail.com>
         Luke Mahe <lukem@google.com>

URL: https://code.google.com/p/io-2012-slides
-->
<!DOCTYPE html>
<html>
<head>
  <title>eZ Summercamp 2013</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">-->
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
  <!--This one seems to work all the time, but really small on ipad-->
  <!--<meta name="viewport" content="initial-scale=0.4">-->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" media="all" href="theme/css/default.css">
  <!--link rel="stylesheet" media="all" href="theme/css/app.css"-->
  <link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="theme/css/phone.css">
  <base target="_blank"> <!-- This amazingness opens all links in a new tab. -->
  <script data-main="js/slides" src="js/require-1.0.8.min.js"></script>
</head>
<body style="opacity: 0">

<slides class="layout-widescreen">

<slide class="logoslide nobackground">
  <article class="flexbox vcenter">
    <span><img src="images/cjwlogo.png"></span>
  </article>
</slide>

<slide class="title-slide segue nobackground">
  <aside class="gdbar"><img src="images/cjwlogo_128.png"></aside>
  <!-- The content of this hgroup is replaced programmatically through the slide_config.json. -->
  <hgroup class="auto-fadein">
    <h1 data-config-title><!-- populated from slide_config.json --></h1>
    <h2 data-config-subtitle><!-- populated from slide_config.json --></h2>
    <p data-config-presenter><!-- populated from slide_config.json --></p>
  </hgroup>
</slide>


<slide class="big" >
  
    <hgroup>
      <h2>Presenters</h2>
      <h3></h3>
    </hgroup>
    <article ><!---

  eZ Summercamp 2014 Talk

  Learnings from Real eZ Publish 5 Projects

  (c) 2014 Ekkehard DÃ¶rre, Donat Fritschy

-->

<ul class="build">
<li><strong>Ekke</strong> is a consultant with deep knowledge in eZ Publish 4 and 5, eZ Find / Apache Solr and with a faible for coming cutting edge web technologies. He is one of the organizers of the PHP Unconference since seven years.</li>
<li><strong>Donat</strong> is owner of Webmanufaktur, a full service web agency in Switzerland. He works as projects manager, software architect and developer and likes thinking outside of the box. In the last year he has been involved in major eZ 5 projects.</li>
<li>Members of CJW Network</li>
</ul></article>
 
</slide>

<slide class="big" >
  
    <hgroup>
      <h2>Learnings from Real eZ Publish 5 Projects</h2>
      <h3></h3>
    </hgroup>
    <article ><ul class="build">
<li>Last year we have presented our Cookbok</li>
<li>In the meantime we have realized a couple of larger and smaller eZ 5 projects</li>
<li>We want to share these experiences</li>
</ul></article>
 
</slide>

<slide class="big" >
  
    <hgroup>
      <h2>Agenda</h2>
      <h3></h3>
    </hgroup>
    <article ><p>Things we'll cover:</p>
<ul class="build">
<li>Best Practice</li>
<li>Debugging</li>
<li>
<p>Pitfalls</p>
</li>
<li>
<p>MultiSite Setup</p>
</li>
</ul></article>
 
</slide>

<slide class="segue dark nobackground" >
  
    <aside class="gdbar"><img src="images/cjwlogo_128.png"></aside>
    <hgroup class="auto-fadein">
      <h2>Best Practice</h2>
      <h3></h3>
    </hgroup>
  
</slide>

<slide  >
  
    <hgroup>
      <h2>TODO einzelne Slides</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>Project Layout</li>
<li>Config Files</li>
<li>Controller per Full View</li>
<li>Base Bundle</li>
</ul></article>
 
</slide>

<slide class="segue dark nobackground" >
  
    <aside class="gdbar"><img src="images/cjwlogo_128.png"></aside>
    <hgroup class="auto-fadein">
      <h2>Debugging</h2>
      <h3>Coping with blank screens</h3>
    </hgroup>
  
</slide>

<slide  >
  
    <hgroup>
      <h2>Blank screen, "503 Service not available"</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>PHP errors (Syntax error, Memory, Outdated Autoloads, ...)</li>
<li>
<p>Configuration errors (DB connection, ...)</p>
</li>
<li>
<p>Switch to DEV mode for better debugging</p>
</li>
<li>Check the log files
<pre>
    Apache/PHP Log
    ezpublish/logs/&lt;env&gt;.log
    ezpublish_legacy/var/log/*
    ezpublish_legacy/var/&lt;siteaccess&gt;/log/*
</pre></li>
<li>Check write permissions on log files!</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>TwigBundle:Exception:error500.html.twig</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>NEVER a Twig error!</li>
<li>
<p>Caused by response 500 "Internal Server Error" and missing error template</p>
</li>
<li>
<p>Checks as before</p>
</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Twig Exception: Invalid variation "&lt;variation&gt;"</h2>
      <h3></h3>
    </hgroup>
    <article ><p>Caused by problems when accessing images</p>
<ul>
<li>Check if the file exists</li>
<li>Check permissions on <code>ezpublish_legacy/var/&lt;siteaccess&gt;/storage</code></li>
<li>Check log files</li>
<li>Clear cache</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Class 'ezxFormToken' not found</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>Usually found with fresh installations involving legacy extensions</li>
<li>Regenerate Autoloads</li>
</ul>
<pre class="prettyprint" data-lang="bash">
$ cd ezpublish_legacy
$ php bin/php/ezpgenerateautoloads.php -e -p
</pre></article>
 
</slide>

<slide class="segue dark nobackground" >
  
    <aside class="gdbar"><img src="images/cjwlogo_128.png"></aside>
    <hgroup class="auto-fadein">
      <h2>Pitfalls</h2>
      <h3>Avoid the traps...</h3>
    </hgroup>
  
</slide>

<slide  >
  
    <hgroup>
      <h2>Memory limit exceeded in DEV mode</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>DEV mode takes a lot of memory</li>
<li>Stash Logging is the worst</li>
<li>Disable Stash Logging in ezpublish.yml</li>
</ul>
<pre class="prettyprint" data-lang="yml">
stash:
    <b>logging: false</b>
    caches:
        default:
            handlers:
                - FileSystem
            inMemory: true
            registerDoctrineAdapter: false
</pre></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>414 Request-URI Too Long</h2>
      <h3></h3>
    </hgroup>
    <article ><p>When doing subrequests, particularly ESI or Hinclude ones, current SiteAccess is transmitted in a serialized form, with its matcher. With a large number of configured SiteAccesses using Map\Host or Map\URI matcher (around 40, which is not uncommon for a multi-national, multi-lingual site) the URL can exceed the size of 8192 Bytes which most servers accept. As a result, the ESI/Hinclude call fails.</p>
<ul>
<li>Fixed in Version 5.3.3 (2014.07)</li>
<li><a href="https://jira.ez.no/browse/EZP-23168">https://jira.ez.no/browse/EZP-23168</a></li>
<li><a href="https://github.com/ezsystems/ezpublish-kernel/pull/949">https://github.com/ezsystems/ezpublish-kernel/pull/949</a></li>
</ul></article>
 
</slide>

<slide class="segue dark nobackground" >
  
    <aside class="gdbar"><img src="images/cjwlogo_128.png"></aside>
    <hgroup class="auto-fadein">
      <h2>eZ View Cache vs. HTTP Caching</h2>
      <h3></h3>
    </hgroup>
  
</slide>

<slide  >
  
    <hgroup>
      <h2>eZ View Caching</h2>
      <h3></h3>
    </hgroup>
    <article ><p>When the pagelayout is rendered, the <code>{$module_result.content}</code> part will be replaced with the actual output. If view caching is enabled, the entire result of the module will be cached. This means that the contents of the "module_result" variable will be put into a cache file (...)</p>
<p>When a new version (...) of an object is published, the system will automatically clear the view cache for the following items:</p>
<ul>
<li>All published nodes of the object</li>
<li>The parent nodes</li>
<li>Related nodes (keywords, object relations)</li>
</ul>
<p><a href="https://doc.ez.no/eZ-Publish/Technical-manual/4.x/Features/View-caching">https://doc.ez.no/eZ-Publish/Technical-manual/4.x/Features/View-caching</a></p></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>HTTP Expiration and Validation</h2>
      <h3></h3>
    </hgroup>
    <article ><p>The HTTP specification defines two caching models:</p>
<ul>
<li>With the <strong>expiration model</strong>, you simply specify how long a response should be considered "fresh" by including a Cache-Control and/or an Expires header. Caches that understand expiration will not make the same request until the cached version reaches its expiration time and becomes "stale";</li>
<li>When pages are really dynamic (i.e. their representation changes often), the <strong>validation model</strong> is often necessary. With this model, the cache stores the response, but asks the server on each request whether or not the cached response is still valid. The application uses a unique response identifier (the Etag header) and/or a timestamp (the Last-Modified header) to check if the page has changed since being cached.</li>
</ul>
<p><a href="http://symfony.com/doc/current/book/http_cache.html">http://symfony.com/doc/current/book/http_cache.html</a></p></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>In Short (and much simplified...)</h2>
      <h3></h3>
    </hgroup>
    <article ><p>eZ View Cache caches <strong>content</strong> and <strong>content fragements</strong></p>
<ul>
<li>Standard TTL is 2 hours</li>
<li>Is purged on content modifications (with smart cache clearing rules)</li>
</ul>
<p>Symfony's HTTP Cache caches <strong>requests</strong></p>
<ul>
<li>eZ uses Expiration model by default</li>
<li>Standard TTL is 60 seconds (86400 for tree menu!)</li>
<li>Symfony Cache is purged from backend, <strong>but only for ONE location</strong></li>
</ul>
<p>Let's dive in a bit deeper...</p></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>ez 4 Cache Directives</h2>
      <h3></h3>
    </hgroup>
    <article ><p>Code from <code>ezpublish_legacy/kernel/private/classes/ezpkernelweb.php</code></p>
<pre class="prettyprint" data-lang="php">
// send header information
foreach (
    eZHTTPHeader::headerOverrideArray( $this->uri ) +
    array(
        <b>'Expires' => 'Mon, 26 Jul 1997 05:00:00 GMT',
        'Last-Modified' => gmdate( 'D, d M Y H:i:s' ) . ' GMT',
        'Cache-Control' => 'no-cache, must-revalidate',
        'Pragma' => 'no-cache',</b>
        ...
      ) as $key => $value
)
{
    header( $key . ': ' . $value );
}
</pre>

<p><strong>This guarantees that every request is handled by eZ</strong></p></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>eZ 5 Cache Directives</h2>
      <h3></h3>
    </hgroup>
    <article ><p>Code from <code>vendor/ezsystems/demobundle/EzSystems/DemoBundle/Controller/DemoController.php</code></p>
<pre class="prettyprint" data-lang="php">
// Setting HTTP cache for the response to be public and with a TTL of 1 day.
$response = new Response;
$response->setPublic();
$response->setSharedMaxAge( 86400 );
// Menu will expire when top location cache expires.
$response->headers->set( 'X-Location-Id', $rootLocationId );
// Menu might vary depending on user permissions, so make the cache vary on the user hash.
$response->setVary( 'X-User-Hash' );
</pre>

<p><strong>This effectively sets the Response free, out of the reach of eZ</strong></p></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Emulating eZ 4 Cache behaviour in eZ 5</h2>
      <h3></h3>
    </hgroup>
    <article ><p>This patch to <code>index.php</code> disables client and proxy caching without sacrifying the benefits of the Symfony HTTP cache. Use at own risk!</p>
<pre class="prettyprint" data-lang="php">
$response = $kernel->handle( $request );
<b>
// Emulate eZ 4 cache control
$response->headers->set( 'Cache-Control', 'no-cache, must-revalidate' );
</b>
$response->send();
$kernel->terminate( $request, $response );
</pre></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2>Cache Recommendations</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>Read the specifications</li>
<li>Use Shared Caches with caution</li>
<li>Set TTL values low enough</li>
<li>Cave: <code>setTtl()</code> vs. <code>setClientTtl</code></li>
<li>
<p>For higher traffic sites, use Varnish</p>
</li>
<li>
<p><a href="http://tools.ietf.org/html/rfc2616#page-74">http://tools.ietf.org/html/rfc2616#page-74</a></p>
</li>
<li><a href="https://www.mnot.net/cache_docs/">https://www.mnot.net/cache_docs/</a></li>
</ul></article>
 
</slide>

<slide class="segue dark nobackground" >
  
    <aside class="gdbar"><img src="images/cjwlogo_128.png"></aside>
    <hgroup class="auto-fadein">
      <h2>MultiSite Setup</h2>
      <h3></h3>
    </hgroup>
  
</slide>

<slide  >
  
    <hgroup>
      <h2>TODO Multisite Setup einzelne Slides</h2>
      <h3></h3>
    </hgroup>
    <article ><ul>
<li>Symfony Way</li>
<li>CJW Way</li>
</ul></article>
 
</slide>

<slide  >
  
    <hgroup>
      <h2></h2>
      <h3></h3>
    </hgroup>
    <article ></article>
 
</slide>


<slide class="thank-you-slide segue nobackground">
  <aside class="gdbar right"><img src="images/cjwlogo_128.png"></aside>
  <article class="flexbox vleft auto-fadein">
    <h2>&lt;Thank You!&gt;</h2>
    <p>Ekkehard D&ouml;rre<br>
    <a href="http://share.ez.no/community/profile/7431">http://share.ez.no/community/profile/7431</a><br>
    <a href="https://twitter.com/ekkeD">@ekkeD</a><br>
    <a href="http://www.coolscreen.de">http://www.coolscreen.de</a></p>
    <p>Donat Fritschy<br>
    <a href="https://github.com/dfritschy">https://github.com/dfritschy</a><br>
    <a href="http://share.ez.no/community/profile/10451">http://share.ez.no/community/profile/10451</a><br>
    <a href="https://twitter.com/webmanufaktur">@webmanufaktur</a><br>
    <a href="http://www.webmanufaktur.ch">http://www.webmanufaktur.ch</a></p>
  </article>
  <!--
  <p class="auto-fadein" data-config-contact>
    <!-- populated from slide_config.json - ->
  </p>
  -->
</slide>

<slide class="backdrop"></slide>

</slides>

<!--
<script>
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-XXXXXXXX-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>
-->

<!--[if IE]>
  <script src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js"></script>
  <script>CFInstall.check({mode: 'overlay'});</script>
<![endif]-->
</body>
</html>